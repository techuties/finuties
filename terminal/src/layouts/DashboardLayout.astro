---
import '../styles/global.css';
import CookieConsent from '../components/CookieConsent.astro';
import { ViewTransitions } from 'astro:transitions';

interface Props {
  title: string;
  description?: string;
  active?: string;
}

const { title, description = 'FinUites Terminal Community dashboard', active = '' } = Astro.props;
const site = String(Astro.site ?? '').replace(/\/$/, '');
const canonical = `${site}${Astro.url.pathname}`;
const API_ORIGIN = import.meta.env.PUBLIC_API_ORIGIN || 'https://data.finuties.com';
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content={description} />
    <meta name="robots" content="noindex, nofollow" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <title>{title}</title>
    <link rel="canonical" href={canonical} />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <ViewTransitions />
    <!-- Metrility GDPR pixel — always loaded, no cookies -->
    <script defer src="https://metrility.techuties.com/pixel/c3uccz757lWXiLzL"></script>
    <!-- Full Metrility pixel — loaded only if user accepted cookies -->
    <script is:inline>
      if (localStorage.getItem('fin_cookie_consent') === 'accepted') {
        var s = document.createElement('script');
        s.defer = true;
        s.src = 'https://metrility.techuties.com/pixel/zO8DpTMfzda1A6MJ';
        document.head.appendChild(s);
      }
    </script>
  </head>
  <body class="font-sans antialiased text-slate-200 bg-fin-950">
    <header class="border-b border-fin-800 bg-fin-900/90 backdrop-blur sticky top-0 z-50" transition:persist>
      <nav class="mx-auto flex max-w-[1400px] flex-wrap items-center justify-between gap-3 px-4 py-3 sm:gap-4 sm:px-6 sm:py-4 lg:px-8" aria-label="Dashboard">
        <a href="/dashboard" class="text-lg sm:text-xl flex-shrink-0" style="font-weight:400;color:#e2e8f0">Fin<span style="font-weight:800;color:#3b82f6">U</span>ties <span style="color:#64748b;font-weight:400;font-size:.875rem">Terminal Community</span></a>
        <div id="global-search" class="hidden sm:block flex-1 max-w-md mx-4"></div>
        <div class="flex flex-wrap items-center justify-end gap-2 sm:gap-4">
          <a href="/dashboard" class:list={["text-sm transition-colors", active === 'dashboard' ? 'text-white font-medium' : 'text-slate-400 hover:text-white']}>Dashboard</a>
          <a href="/explore" class:list={["text-sm transition-colors", active === 'explore' ? 'text-white font-medium' : 'text-slate-400 hover:text-white']}>Explore</a>
          <a href="/analyze" class:list={["text-sm transition-colors", active === 'analyze' ? 'text-white font-medium' : 'text-slate-400 hover:text-white']}>Analyze</a>
          <a href="/commodities" class:list={["text-sm transition-colors", active === 'commodities' ? 'text-white font-medium' : 'text-slate-400 hover:text-white']}>Commodities</a>
          <a href="/global" class:list={["text-sm transition-colors", active === 'global' ? 'text-white font-medium' : 'text-slate-400 hover:text-white']}>Global</a>
          <a href={`${API_ORIGIN}/docs`} target="_blank" rel="noopener noreferrer" class="text-sm text-slate-400 hover:text-white transition-colors inline-flex items-center gap-1">API Docs <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg></a>
          <a id="nav-account" href="https://www.finuties.com/settings" target="_blank" rel="noopener noreferrer" class="text-sm text-slate-400 hover:text-white transition-colors inline-flex items-center gap-1"><svg class="w-3.5 h-3.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0" /></svg> <span id="nav-username">Account</span></a>
          <span class="hidden sm:inline text-slate-700">|</span>
          <a href="/disconnect" class="text-sm text-red-400 hover:text-red-300 transition-colors">Sign Out</a>
        </div>
      </nav>
    </header>
    <main class="min-h-[60vh]" transition:animate="fade">
      <slot />
    </main>
    <CookieConsent />
    <script>
      import { initSearchBar } from '../lib/search-bar';
      import { getApiConfig } from '../lib/api-client';
      import { isApiKeyToken } from '../lib/auth/bootstrap';

      // Terminal pages require FinUties API key auth.
      const activeConfig = getApiConfig();
      if (!activeConfig || !isApiKeyToken(activeConfig.token)) {
        window.location.replace('/?apikey=1');
      }

      const sc = document.getElementById('global-search');
      if (sc) initSearchBar(sc);

      // Populate nav username from /api/v1/auth/me
      (async () => {
        const cfg = getApiConfig();
        if (!cfg || !isApiKeyToken(cfg.token)) return;
        try {
          const r = await fetch(`${cfg.base.replace(/\/+$/, '')}/api/v1/auth/me`, {
            headers: { Authorization: `Bearer ${cfg.token}` },
          });
          if (!r.ok) return;
          const me = await r.json() as { username?: string; id?: string };
          const span = document.getElementById('nav-username');
          if (span && (me.username || me.id)) {
            span.textContent = me.username || me.id || 'Account';
          }
        } catch { /* silent — keep "Account" fallback */ }
      })();
    </script>
  </body>
</html>
